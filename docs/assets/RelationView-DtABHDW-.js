import{q as e,r as t,y as a,z as o,e as l,f as r,b as i}from"./element-plus-D5xJ9DPN.js";import{B as s}from"./BREAK-LibRWxXm.js";import{a as c,u as n}from"./vue-router-BEXBg7Fd.js";import{u}from"./vue-i18n-U3rzzJhO.js";import{P as d}from"./relation-graph-CUtAT3hc.js";import{d as v,b as k,r as p,t as h,w as b,A as f,D as y,_ as x,Q as m,E as A,O as E,ab as T,u as R,B as C,U as M,ac as B,V as K}from"./vue-CxVCOtPj.js";import{_ as g}from"./index-C-Mj8UtD.js";import"./BREAK-Risks-tud6J5-y.js";import"./BREAK-utils-dekRhMIS.js";import"./BREAK-Avoidances-CkuVuIR8.js";import"./BREAK-AttackTools-B7v_fDTB.js";import"./BREAK-ThreatActors-DscyYbs6.js";const j={style:{border:"#efefef solid 1px",height:"calc(100vh - 150px)",width:"100%"}},L=["onDblclick","onContextmenu","innerHTML"],$={class:"filter-pane",id:"node-filter-pane"},_={style:{"margin-top":"8px"}},O={class:"filter-pane",id:"line-filter-pane"};var w=(e=>(e.risk="risk",e.avoidance="avoidance",e.attackTool="attack-tool",e.threatActor="threat-actor",e.abilityProvider="ability-provider",e.all="all",e))(w||{});const V=g(v({__name:"RelationView",setup(v){const g=c(),V=n(),{t:N,locale:P}=u(),S={risk:{get title(){return N("relationType.risk")},relType:"risk",BreakKey:"risks",color:"orange",disableContextMenu:k(!1)},avoidance:{get title(){return N("relationType.avoidance")},relType:"avoidance",BreakKey:"avoidances",color:"green",disableContextMenu:k(!1)},"attack-tool":{get title(){return N("relationType.attackTool")},relType:"attack-tool",BreakKey:"attackTools",color:"blue",disableContextMenu:k(!1)},"threat-actor":{get title(){return N("relationType.threatActor")},relType:"threat-actor",BreakKey:"threatActors",color:"red",disableContextMenu:k(!1)},"ability-provider":{get title(){return N("relationType.abilityProvider")},relType:"ability-provider",BreakKey:"abilityProviders",color:"purple",disableContextMenu:k(!1)}},I=k(g.params.type),D=k(g.params.key),U=k(),H=p({allowShowMiniToolBar:!0,disableZoom:!1,disableDragCanvas:!1,defaultExpandHolderPosition:"right",defaultShowLineLabel:!0,defaultNodeWidth:120,defaultNodeHeight:120,moveToCenterWhenRefresh:!0,zoomToFitWhenRefresh:!0});H.layout={layoutLabel:"中心布局",layoutName:"center",distance_coefficient:2,maxLayoutTimes:20,force_line_elastic:.3,force_node_repulsion:3};const z=p([]),F=p([]),J=p({rootId:D.value,nodes:z,lines:F}),W=()=>{const e=S[I.value];void 0!==s[e.BreakKey][D.value]?z.push({id:D.value,type:e.relType,text:D.value+"<br>"+N(`BREAK.${S[I.value].BreakKey}.${D.value}.title`),color:e.color}):alert(N("unknownId"))},q=e=>{s.risks[e].avoidances.forEach(t=>{z.push({id:t,type:"avoidance",text:t+"<br>"+N(`BREAK.avoidances.${t}.title`),color:S.avoidance.color}),F.push({from:e,text:N("relationLine.avoidanceMeans"),to:t})})},Q=e=>{Object.keys(s.attackTools).filter(t=>s.attackTools[t].couseRisks.includes(e)).forEach(t=>{z.push({id:t,type:"attack-tool",text:t+"<br>"+N(`BREAK.attackTools.${t}.title`),color:S["attack-tool"].color}),F.push({from:e,text:N("relationLine.makeRisk"),to:t})})},X=e=>{Object.keys(s.threatActors).filter(t=>s.threatActors[t].couseRisks.includes(e)).forEach(t=>{z.push({id:t,type:"threat-actor",text:t+"<br>"+N(`BREAK.threatActors.${t}.title`),color:S["threat-actor"].color}),F.push({from:t,text:N("relationLine.causeRisk"),to:e})})},Y=e=>{Object.keys(s.risks).filter(t=>s.risks[t].avoidances.includes(e)).forEach(t=>{z.push({id:t,type:"risk",text:t+"<br>"+N(`BREAK.risks.${t}.title`),color:S.risk.color}),F.push({from:t,text:N("relationLine.avoidanceMeans"),to:e})})},Z=e=>{Object.keys(s.abilityProviders).filter(t=>Object.keys(s.abilityProviders[t].abilities).includes(e)).forEach(t=>{z.push({id:t,type:"ability-provider",text:t+"<br>"+N(`BREAK.abilityProviders.${t}.title`),color:S["ability-provider"].color}),F.push({from:e,text:N("relationLine.abilityProvider"),to:t})})},G=e=>{s.attackTools[e].couseRisks.forEach(t=>{z.push({id:t,type:"risk",text:t+"<br>"+N(`BREAK.risks.${t}.title`),color:S.risk.color}),F.push({from:e,text:N("relationLine.makeRisk"),to:t})})},ee=e=>{s.attackTools[e].avoidances.forEach(t=>{z.push({id:t,type:"avoidance",text:t+"<br>"+N(`BREAK.avoidances.${t}.title`),color:S.avoidance.color}),F.push({from:e,text:N("relationLine.avoidanceMeans"),to:t})})},te=e=>{Object.keys(s.threatActors).filter(t=>s.threatActors[t].buildAttackTools.includes(e)).forEach(t=>{z.push({id:t,type:"threat-actor",text:t+"<br>"+N(`BREAK.threatActors.${t}.title`),color:S["threat-actor"].color}),F.push({from:t,text:N("relationLine.buildAttackTool"),to:e})});Object.keys(s.threatActors).filter(t=>s.threatActors[t].useAttackTools.includes(e)).forEach(t=>{z.push({id:t,type:"threat-actor",text:t+"<br>"+N(`BREAK.threatActors.${t}.title`),color:S["threat-actor"].color}),F.push({from:t,text:N("relationLine.useAttackTool"),to:e})})},ae=e=>{s.threatActors[e].couseRisks.forEach(t=>{z.push({id:t,type:"risk",text:t+"<br>"+N(`BREAK.risks.${t}.title`),color:S.risk.color}),F.push({from:e,text:N("relationLine.causeRisk"),to:t})})},oe=e=>{s.threatActors[e].buildAttackTools.forEach(t=>{z.push({id:t,type:"attack-tool",text:t+"<br>"+N(`BREAK.attackTools.${t}.title`),color:S["attack-tool"].color}),F.push({from:e,text:N("relationLine.buildAttackTool"),to:t})});s.threatActors[e].useAttackTools.forEach(t=>{z.push({id:t,type:"attack-tool",text:t+"<br>"+N(`BREAK.attackTools.${t}.title`),color:S["attack-tool"].color}),F.push({from:e,text:N("relationLine.useAttackTool"),to:t})})},le=()=>{(()=>{const e=new Set;F.forEach(t=>{e.add(JSON.stringify(t))}),F.splice(0,F.length),e.forEach(e=>{F.push(JSON.parse(e))})})(),U?.value?.setJsonData(J),fe()},re=(e,t,a)=>{var o,l,r,i,c;"risk"===t?"avoidance"==e?q(a):"attack-tool"==e?Q(a):"threat-actor"==e?X(a):"all"==e&&(q(a),Q(a),(e=>{const t=s.risks[e].avoidances;Object.keys(s.attackTools).filter(t=>s.attackTools[t].couseRisks.includes(e)).forEach(e=>{t.forEach(t=>{s.attackTools[e].avoidances.includes(t)&&F.push({from:t,text:N("relationLine.avoidanceMeans"),to:e})})})})(a),X(a),(e=>{const t=Object.keys(s.threatActors).filter(t=>s.threatActors[t].couseRisks.includes(e)),a=Object.keys(s.attackTools).filter(t=>s.attackTools[t].couseRisks.includes(e));t.forEach(e=>{a.forEach(t=>{s.threatActors[e].useAttackTools.includes(t)?F.push({from:e,text:N("relationLine.useAttackTool"),to:t}):s.threatActors[e].buildAttackTools.includes(t)&&F.push({from:e,text:N("relationLine.buildAttackTool"),to:t})})})})(a),c=a,Object.keys(s.risks).filter(e=>e.includes(c)&&e!=c).forEach(e=>{z.push({id:e,type:"risk",text:e+"<br>"+N(`BREAK.risks.${e}.title`),color:S.risk.color,isSubNode:!0}),F.push({from:c,text:N("relationLine.subRisk"),to:e})})):"avoidance"===t?("risk"==e&&Y(a),"ability-provider"==e&&Z(a),"all"==e&&(Y(a),Z(a),i=a,Object.keys(s.avoidances).filter(e=>e.includes(i)&&e!=i).forEach(e=>{z.push({id:e,type:"avoidance",text:e+"<br>"+N(`BREAK.avoidances.${e}.title`),color:S.avoidance.color,isSubNode:!0}),F.push({from:i,text:N("relationLine.subAvoidance"),to:e})}))):"attack-tool"===t?"risk"==e?G(a):"avoidance"==e?ee(a):"threat-actor"==e?te(a):"all"==e&&(G(a),ee(a),(e=>{const t=s.attackTools[e].couseRisks,a=s.attackTools[e].avoidances;t.forEach(e=>{s.risks[e].avoidances.forEach(t=>{a.includes(t)&&F.push({from:e,text:N("relationLine.avoidanceMeans"),to:t})})})})(a),te(a),(e=>{const t=Object.keys(s.threatActors).filter(t=>s.threatActors[t].buildAttackTools.includes(e)),a=Object.keys(s.threatActors).filter(t=>s.threatActors[t].useAttackTools.includes(e)),o=s.attackTools[e].couseRisks;t.forEach(e=>{o.forEach(t=>{s.threatActors[e].couseRisks.includes(t)&&F.push({from:t,text:N("relationLine.attackToolMaker"),to:e})})}),a.forEach(e=>{o.forEach(t=>{s.threatActors[e].couseRisks.includes(t)&&F.push({from:e,text:N("relationLine.causeRisk"),to:t})})})})(a),r=a,Object.keys(s.attackTools).filter(e=>e.includes(r)&&e!=r).forEach(e=>{z.push({id:e,type:"attack-tool",text:e+"<br>"+N(`BREAK.attackTools.${e}.title`),color:S["attack-tool"].color,isSubNode:!0}),F.push({from:r,text:N("relationLine.subAttackTool"),to:e})})):"threat-actor"===t?"risk"==e?ae(a):"attack-tool"==e?oe(a):"all"==e&&(ae(a),oe(a),(e=>{const t=[...s.threatActors[e].buildAttackTools,...s.threatActors[e].useAttackTools],a=s.threatActors[e].couseRisks;t.forEach(e=>{a.forEach(t=>{s.attackTools[e].couseRisks.includes(t)&&F.push({from:e,text:N("relationLine.causeRisk"),to:t})})})})(a),l=a,Object.keys(s.threatActors).filter(e=>e.includes(l)&&e!=l).forEach(e=>{z.push({id:e,type:"threat-actor",text:e+"<br>"+N(`BREAK.threatActors.${e}.title`),color:S["threat-actor"].color,isSubNode:!0}),F.push({from:l,text:N("relationLine.subThreatActor"),to:e})})):"ability-provider"===t&&("avoidance"!=e&&"all"!=e||(o=a,Object.keys(s.abilityProviders[o].abilities).forEach(e=>{z.push({id:e,type:"avoidance",text:e+"<br>"+N(`BREAK.avoidances.${e}.title`),color:S.avoidance.color}),F.push({from:e,text:N("relationLine.abilityProvider"),to:o})}))),le()};h(()=>{if(!Object.values(w).includes(g.params.type)||!Object.keys(s[S[g.params.type].BreakKey]).includes(g.params.key))return alert(N("unknownTypeOrId")),void V.push({name:"relation",params:{type:"risk",key:"R0001"}}).then(()=>{location.reload()});W(),re("all",I.value,D.value)}),b(()=>D.value,e=>{e!==g.params.key&&V.push({name:"relation",params:{type:I.value,key:e}})}),b(()=>[g.params.type,g.params.key],()=>{I.value=g.params.type,D.value=g.params.key,z.splice(0,z.length),F.splice(0,F.length),W(),re("all",I.value,D.value)}),b(P,()=>{z.splice(0,z.length),F.splice(0,F.length),ye.value=[],W(),re("all",I.value,D.value)});const ie=p({position:"absolute",zIndex:65535,top:"0px",left:"0px",display:"none"}),se=k(),ce=k(!1),ne=k(!1),ue=k(""),de=k(""),ve=(e,t)=>{switch(ie.top=t.clientY+"px",ie.left=t.clientX+"px",ie.display="block",se.value?.handleOpen(),e.type){case"risk":S.risk.disableContextMenu.value=!0,S.avoidance.disableContextMenu.value=!1,S["attack-tool"].disableContextMenu.value=!1,S["threat-actor"].disableContextMenu.value=!1,S["ability-provider"].disableContextMenu.value=!0,ce.value=!1,ne.value=!1;break;case"avoidance":S.risk.disableContextMenu.value=!1,S.avoidance.disableContextMenu.value=!0,S["attack-tool"].disableContextMenu.value=!0,S["threat-actor"].disableContextMenu.value=!0,S["ability-provider"].disableContextMenu.value=!1,ce.value=!1,ne.value=!1;break;case"attack-tool":S.risk.disableContextMenu.value=!1,S.avoidance.disableContextMenu.value=!1,S["attack-tool"].disableContextMenu.value=!0,S["threat-actor"].disableContextMenu.value=!1,S["ability-provider"].disableContextMenu.value=!0,ce.value=!1,ne.value=!1;break;case"threat-actor":S.risk.disableContextMenu.value=!1,S.avoidance.disableContextMenu.value=!0,S["attack-tool"].disableContextMenu.value=!1,S["threat-actor"].disableContextMenu.value=!0,S["ability-provider"].disableContextMenu.value=!0,ce.value=!1,ne.value=!1;break;case"ability-provider":S.risk.disableContextMenu.value=!0,S.avoidance.disableContextMenu.value=!1,S["attack-tool"].disableContextMenu.value=!0,S["threat-actor"].disableContextMenu.value=!0,S["ability-provider"].disableContextMenu.value=!0,ce.value=!0,ne.value=!1}e.id==D.value&&(ne.value=!0),ue.value=e.type,de.value=e.id},ke=e=>{re(e,ue.value,de.value)},pe=k(["risk","avoidance","attack-tool","threat-actor","ability-provider"]),he=k(!0),be=k([]),fe=()=>{be.value.splice(0,be.value.length),F.forEach(e=>{be.value.includes(e.text)||be.value.push(e.text)}),be.value.forEach(e=>{ye.value.includes(e)||ye.value.push(e)})},ye=k(be.value),xe=()=>{const e=U.value?.getInstance().getNodes(),t=U.value?.getInstance().getLinks();e?.forEach(e=>{const t=e.isSubNode,a=!pe.value.includes(e.type)||t&&!he.value;e.isHide=a}),t?.forEach(e=>{e.relations.forEach(e=>{e.isHide=!ye.value.includes(e.text)})}),U.value?.getInstance().dataUpdated(),U.value?.getInstance().refresh(!0)};return(c,n)=>{const u=t,v=e,k=o,p=a,h=r,b=l,g=i;return f(),y("div",j,[x(R(d),{ref_key:"graphRef$",ref:U,options:H},{node:m(({node:e})=>[A("div",{style:{cursor:"pointer","font-size":"16px",display:"flex",height:"inherit","align-items":"center","justify-content":"center"},onDblclick:t=>ve(e,t),onContextmenu:t=>ve(e,t),innerHTML:e.text},null,40,L)]),"graph-plug":m(()=>[A("div",$,[A("div",null,[x(v,{style:{width:"200px"},modelValue:I.value,"onUpdate:modelValue":n[0]||(n[0]=e=>I.value=e)},{default:m(()=>[(f(),y(E,null,T(S,(e,t)=>x(u,{label:e.title,key:t,value:t},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),A("div",_,[x(v,{style:{width:"200px"},modelValue:D.value,"onUpdate:modelValue":n[1]||(n[1]=e=>D.value=e)},{default:m(()=>[(f(!0),y(E,null,T(R(s)[S[I.value].BreakKey],(e,t)=>(f(),C(u,{key:t,label:t+":"+c.$t(`BREAK.${S[I.value].BreakKey}.${t}.title`),value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),A("h2",null,M(c.$t("nodeFilter")),1),x(p,{modelValue:pe.value,"onUpdate:modelValue":n[2]||(n[2]=e=>pe.value=e),onChange:xe},{default:m(()=>[(f(),y(E,null,T(S,(e,t)=>x(k,{key:t,name:t,class:"filter-checkbox",value:t},{default:m(()=>[B(M(e.title),1)]),_:2},1032,["name","value"])),64))]),_:1},8,["modelValue"]),x(k,{modelValue:he.value,"onUpdate:modelValue":n[3]||(n[3]=e=>he.value=e),class:"filter-checkbox",onChange:xe},{default:m(()=>[B(M(c.$t("subNodeFilter")),1)]),_:1},8,["modelValue"])]),A("div",O,[A("h2",null,M(c.$t("lineFilter")),1),x(p,{modelValue:ye.value,"onUpdate:modelValue":n[4]||(n[4]=e=>ye.value=e),onChange:xe},{default:m(()=>[(f(!0),y(E,null,T(be.value,e=>(f(),C(k,{class:"filter-checkbox",key:e,name:e,value:e},{default:m(()=>[B(M(e),1)]),_:2},1032,["name","value"]))),128))]),_:1},8,["modelValue"])])]),_:1},8,["options"]),x(g,{ref_key:"dropdown1",ref:se,handleOpen:!0,style:K(ie)},{dropdown:m(()=>[x(b,null,{default:m(()=>[(f(),y(E,null,T(S,(e,t)=>x(h,{key:t,onClick:e=>ke(t),disabled:e.disableContextMenu.value},{default:m(()=>[B(M(e.title),1)]),_:2},1032,["onClick","disabled"])),64)),x(h,{onClick:n[5]||(n[5]=e=>ke("all")),disabled:ce.value},{default:m(()=>[B(M(c.$t("fetchAllRelations")),1)]),_:1},8,["disabled"]),x(h,{onClick:n[6]||(n[6]=e=>{V.push({name:"relation",params:{type:ue.value,key:de.value}})}),disabled:ne.value,divided:""},{default:m(()=>[B(M(c.$t("openAsRoot")),1)]),_:1},8,["disabled"]),x(h,{divided:"",onClick:n[7]||(n[7]=e=>(()=>{let e="";switch(ue.value){case"risk":return e="riskDetail",void V.push({name:e,params:{rKey:de.value}});case"avoidance":e="avoidances";break;case"attack-tool":e="attackTools";break;case"threat-actor":e="threatActors";break;case"ability-provider":e="abilityProviders"}V.push({name:e,hash:"#"+de.value})})())},{default:m(()=>[B(M(c.$t("viewDetail")),1)]),_:1})]),_:1})]),default:m(()=>[n[8]||(n[8]=A("span",{class:"el-dropdown-link"},null,-1))]),_:1},8,["style"])])}}}),[["__scopeId","data-v-e322ea28"]]);export{V as default};
