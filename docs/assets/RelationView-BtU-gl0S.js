import{q as e,r as t,y as a,z as o,e as l,f as s,b as r}from"./element-plus-D5xJ9DPN.js";import{B as i}from"./BREAK-BkOc_Hp1.js";import{a as c,u}from"./vue-router-BEXBg7Fd.js";import{P as n}from"./relation-graph-CUtAT3hc.js";import{d,b as p,r as h,t as v,w as k,A as b,D as f,_ as y,Q as x,E as m,O as A,ab as T,u as E,B as C,ac as M,U as j,V as _}from"./vue-CxVCOtPj.js";import{_ as g}from"./index-CuuWf26x.js";import"./BREAK-Risks-tud6J5-y.js";import"./BREAK-utils-dekRhMIS.js";import"./BREAK-Avoidances-CkuVuIR8.js";import"./BREAK-AttackTools-B7v_fDTB.js";import"./BREAK-ThreatActors-DscyYbs6.js";import"./vue-i18n-B9uFukkq.js";const R={style:{border:"#efefef solid 1px",height:"calc(100vh - 150px)",width:"100%"}},O=["onDblclick","onContextmenu","innerHTML"],B={class:"filter-pane",id:"node-filter-pane"},K={style:{"margin-top":"8px"}},w={class:"filter-pane",id:"line-filter-pane"};var V=(e=>(e.risk="risk",e.avoidance="avoidance",e.attackTool="attack-tool",e.threatActor="threat-actor",e.abilityProvider="ability-provider",e.all="all",e))(V||{});const P=g(d({__name:"RelationView",setup(d){const g=c(),P=u(),D={risk:{title:"风险",relType:"risk",BreakKey:"risks",color:"orange",disableContextMenu:p(!1)},avoidance:{title:"规避手段",relType:"avoidance",BreakKey:"avoidances",color:"green",disableContextMenu:p(!1)},"attack-tool":{title:"攻击工具",relType:"attack-tool",BreakKey:"attackTools",color:"blue",disableContextMenu:p(!1)},"threat-actor":{title:"威胁行为者",relType:"threat-actor",BreakKey:"threatActors",color:"red",disableContextMenu:p(!1)},"ability-provider":{title:"能力提供者",relType:"ability-provider",BreakKey:"abilityProviders",color:"purple",disableContextMenu:p(!1)}},I=p(g.params.type),L=p(g.params.key),H=p(),N=h({allowShowMiniToolBar:!0,disableZoom:!1,disableDragCanvas:!1,defaultExpandHolderPosition:"right",defaultShowLineLabel:!0,defaultNodeWidth:120,defaultNodeHeight:120,moveToCenterWhenRefresh:!0,zoomToFitWhenRefresh:!0});N.layout={layoutLabel:"中心布局",layoutName:"center",distance_coefficient:2,maxLayoutTimes:20,force_line_elastic:.3,force_node_repulsion:3};const U=h([]),S=h([]),z=h({rootId:L.value,nodes:U,lines:S}),J=()=>{const e=D[I.value],t=i[e.BreakKey][L.value];void 0!==t?U.push({id:L.value,type:e.relType,text:L.value+"<br>"+t.title,color:e.color}):alert("未知ID")},W=e=>{i.risks[e].avoidances.forEach(t=>{const a=i.avoidances[t];U.push({id:t,type:"avoidance",text:t+"<br>"+a.title,color:D.avoidance.color}),S.push({from:e,text:"规避手段",to:t})})},q=e=>{Object.keys(i.attackTools).filter(t=>i.attackTools[t].couseRisks.includes(e)).forEach(t=>{const a=i.attackTools[t];U.push({id:t,type:"attack-tool",text:t+"<br>"+a.title,color:D["attack-tool"].color}),S.push({from:e,text:"攻击工具",to:t})})},F=e=>{Object.keys(i.threatActors).filter(t=>i.threatActors[t].couseRisks.includes(e)).forEach(t=>{const a=i.threatActors[t];U.push({id:t,type:"threat-actor",text:t+"<br>"+a.title,color:D["threat-actor"].color}),S.push({from:t,text:"造成风险",to:e})})},Q=e=>{Object.keys(i.risks).filter(t=>i.risks[t].avoidances.includes(e)).forEach(t=>{const a=i.risks[t];U.push({id:t,type:"risk",text:t+"<br>"+a.title,color:D.risk.color}),S.push({from:t,text:"规避手段",to:e})})},X=e=>{Object.keys(i.abilityProviders).filter(t=>Object.keys(i.abilityProviders[t].abilities).includes(e)).forEach(t=>{const a=i.abilityProviders[t];U.push({id:t,type:"ability-provider",text:t+"<br>"+a.title,color:D["ability-provider"].color}),S.push({from:e,text:"能力提供者",to:t})})},Y=e=>{i.attackTools[e].couseRisks.forEach(t=>{const a=i.risks[t];U.push({id:t,type:"risk",text:t+"<br>"+a.title,color:D.risk.color}),S.push({from:e,text:"制造风险",to:t})})},Z=e=>{i.attackTools[e].avoidances.forEach(t=>{const a=i.avoidances[t];U.push({id:t,type:"avoidance",text:t+"<br>"+a.title,color:D.avoidance.color}),S.push({from:e,text:"规避手段",to:t})})},$=e=>{Object.keys(i.threatActors).filter(t=>i.threatActors[t].buildAttackTools.includes(e)).forEach(t=>{const a=i.threatActors[t];U.push({id:t,type:"threat-actor",text:t+"<br>"+a.title,color:D["threat-actor"].color}),S.push({from:t,text:"制作攻击工具",to:e})});Object.keys(i.threatActors).filter(t=>i.threatActors[t].useAttackTools.includes(e)).forEach(t=>{const a=i.threatActors[t];U.push({id:t,type:"threat-actor",text:t+"<br>"+a.title,color:D["threat-actor"].color}),S.push({from:t,text:"使用攻击工具",to:e})})},G=e=>{i.threatActors[e].couseRisks.forEach(t=>{const a=i.risks[t];U.push({id:t,type:"risk",text:t+"<br>"+a.title,color:D.risk.color}),S.push({from:e,text:"造成风险",to:t})})},ee=e=>{i.threatActors[e].buildAttackTools.forEach(t=>{const a=i.attackTools[t];U.push({id:t,type:"attack-tool",text:t+"<br>"+a.title,color:D["attack-tool"].color}),S.push({from:e,text:"制作攻击工具",to:t})});i.threatActors[e].useAttackTools.forEach(t=>{const a=i.attackTools[t];U.push({id:t,type:"attack-tool",text:t+"<br>"+a.title,color:D["attack-tool"].color}),S.push({from:e,text:"使用攻击工具",to:t})})},te=()=>{(()=>{const e=new Set;S.forEach(t=>{e.add(JSON.stringify(t))}),S.splice(0,S.length),e.forEach(e=>{S.push(JSON.parse(e))})})(),H?.value?.setJsonData(z),he()},ae=(e,t,a)=>{var o,l,s,r,c;"risk"===t?"avoidance"==e?W(a):"attack-tool"==e?q(a):"threat-actor"==e?F(a):"all"==e&&(W(a),q(a),(e=>{const t=i.risks[e].avoidances;Object.keys(i.attackTools).filter(t=>i.attackTools[t].couseRisks.includes(e)).forEach(e=>{t.forEach(t=>{i.attackTools[e].avoidances.includes(t)&&S.push({from:t,text:"规避手段",to:e})})})})(a),F(a),(e=>{const t=Object.keys(i.threatActors).filter(t=>i.threatActors[t].couseRisks.includes(e)),a=Object.keys(i.attackTools).filter(t=>i.attackTools[t].couseRisks.includes(e));t.forEach(e=>{a.forEach(t=>{i.threatActors[e].useAttackTools.includes(t)?S.push({from:e,text:"使用攻击工具",to:t}):i.threatActors[e].buildAttackTools.includes(t)&&S.push({from:e,text:"制作攻击工具",to:t})})})})(a),c=a,Object.keys(i.risks).filter(e=>e.includes(c)&&e!=c).forEach(e=>{U.push({id:e,type:"risk",text:e+"<br>"+i.risks[e].title,color:D.risk.color}),S.push({from:c,text:"子风险",to:e})})):"avoidance"===t?("risk"==e&&Q(a),"ability-provider"==e&&X(a),"all"==e&&(Q(a),X(a),r=a,Object.keys(i.avoidances).filter(e=>e.includes(r)&&e!=r).forEach(e=>{U.push({id:e,type:"avoidance",text:e+"<br>"+i.avoidances[e].title,color:D.avoidance.color}),S.push({from:r,text:"子规避手段",to:e})}))):"attack-tool"===t?"risk"==e?Y(a):"avoidance"==e?Z(a):"threat-actor"==e?$(a):"all"==e&&(Y(a),Z(a),(e=>{const t=i.attackTools[e].couseRisks,a=i.attackTools[e].avoidances;t.forEach(e=>{i.risks[e].avoidances.forEach(t=>{a.includes(t)&&S.push({from:e,text:"规避手段",to:t})})})})(a),$(a),(e=>{const t=Object.keys(i.threatActors).filter(t=>i.threatActors[t].buildAttackTools.includes(e)),a=Object.keys(i.threatActors).filter(t=>i.threatActors[t].useAttackTools.includes(e)),o=i.attackTools[e].couseRisks;t.forEach(e=>{o.forEach(t=>{i.threatActors[e].couseRisks.includes(t)&&S.push({from:t,text:"攻击工具制造者",to:e})})}),a.forEach(e=>{o.forEach(t=>{i.threatActors[e].couseRisks.includes(t)&&S.push({from:e,text:"造成风险",to:t})})})})(a),s=a,Object.keys(i.attackTools).filter(e=>e.includes(s)&&e!=s).forEach(e=>{U.push({id:e,type:"attack-tool",text:e+"<br>"+i.attackTools[e].title,color:D["attack-tool"].color}),S.push({from:s,text:"子攻击工具",to:e})})):"threat-actor"===t?"risk"==e?G(a):"attack-tool"==e?ee(a):"all"==e&&(G(a),ee(a),(e=>{const t=[...i.threatActors[e].buildAttackTools,...i.threatActors[e].useAttackTools],a=i.threatActors[e].couseRisks;t.forEach(e=>{a.forEach(t=>{i.attackTools[e].couseRisks.includes(t)&&S.push({from:e,text:"造成风险",to:t})})})})(a),l=a,Object.keys(i.threatActors).filter(e=>e.includes(l)&&e!=l).forEach(e=>{U.push({id:e,type:"threat-actor",text:e+"<br>"+i.threatActors[e].title,color:D["threat-actor"].color}),S.push({from:l,text:"子威胁行为者",to:e})})):"ability-provider"===t&&("avoidance"!=e&&"all"!=e||(o=a,Object.keys(i.abilityProviders[o].abilities).forEach(e=>{const t=i.avoidances[e];U.push({id:e,type:"avoidance",text:e+"<br>"+t.title,color:D.avoidance.color}),S.push({from:e,text:"能力提供者",to:o})}))),te()};v(()=>{if(!Object.values(V).includes(g.params.type)||!Object.keys(i[D[g.params.type].BreakKey]).includes(g.params.key))return alert("未知类型或ID"),void P.push({name:"relation",params:{type:"risk",key:"R0001"}}).then(()=>{location.reload()});J(),ae("all",I.value,L.value)}),k(()=>L.value,e=>{e!==g.params.key&&P.push({name:"relation",params:{type:I.value,key:e}})}),k(()=>[g.params.type,g.params.key],()=>{I.value=g.params.type,L.value=g.params.key,U.splice(0,U.length),S.splice(0,S.length),J(),ae("all",I.value,L.value)});const oe=h({position:"absolute",zIndex:65535,top:"0px",left:"0px",display:"none"}),le=p(),se=p(!1),re=p(!1),ie=p(""),ce=p(""),ue=(e,t)=>{switch(oe.top=t.clientY+"px",oe.left=t.clientX+"px",oe.display="block",le.value?.handleOpen(),e.type){case"risk":D.risk.disableContextMenu.value=!0,D.avoidance.disableContextMenu.value=!1,D["attack-tool"].disableContextMenu.value=!1,D["threat-actor"].disableContextMenu.value=!1,D["ability-provider"].disableContextMenu.value=!0,se.value=!1,re.value=!1;break;case"avoidance":D.risk.disableContextMenu.value=!1,D.avoidance.disableContextMenu.value=!0,D["attack-tool"].disableContextMenu.value=!0,D["threat-actor"].disableContextMenu.value=!0,D["ability-provider"].disableContextMenu.value=!1,se.value=!1,re.value=!1;break;case"attack-tool":D.risk.disableContextMenu.value=!1,D.avoidance.disableContextMenu.value=!1,D["attack-tool"].disableContextMenu.value=!0,D["threat-actor"].disableContextMenu.value=!1,D["ability-provider"].disableContextMenu.value=!0,se.value=!1,re.value=!1;break;case"threat-actor":D.risk.disableContextMenu.value=!1,D.avoidance.disableContextMenu.value=!0,D["attack-tool"].disableContextMenu.value=!1,D["threat-actor"].disableContextMenu.value=!0,D["ability-provider"].disableContextMenu.value=!0,se.value=!1,re.value=!1;break;case"ability-provider":D.risk.disableContextMenu.value=!0,D.avoidance.disableContextMenu.value=!1,D["attack-tool"].disableContextMenu.value=!0,D["threat-actor"].disableContextMenu.value=!0,D["ability-provider"].disableContextMenu.value=!0,se.value=!0,re.value=!1}e.id==L.value&&(re.value=!0),ie.value=e.type,ce.value=e.id},ne=e=>{ae(e,ie.value,ce.value)},de=p(["risk","avoidance","attack-tool","threat-actor","ability-provider"]),pe=p([]),he=()=>{pe.value.splice(0,pe.value.length),S.forEach(e=>{pe.value.includes(e.text)||pe.value.push(e.text)})},ve=p(pe.value),ke=()=>{const e=H.value?.getInstance().getNodes(),t=H.value?.getInstance().getLinks();e?.forEach(e=>{let t=!1;de.value.includes(e.type)||(t=!0),e.opacity=t?.1:1}),t?.forEach(e=>{e.relations.forEach(e=>{ve.value.includes(e.text)?e.isHide=!1:e.isHide=!0})}),H.value?.getInstance().dataUpdated()};return(c,u)=>{const d=t,p=e,h=o,v=a,k=s,g=l,V=r;return b(),f("div",R,[y(E(n),{ref_key:"graphRef$",ref:H,options:N},{node:x(({node:e})=>[m("div",{style:{cursor:"pointer","font-size":"16px",display:"flex",height:"inherit","align-items":"center","justify-content":"center"},onDblclick:t=>ue(e,t),onContextmenu:t=>ue(e,t),innerHTML:e.text},null,40,O)]),"graph-plug":x(()=>[m("div",B,[m("div",null,[y(p,{style:{width:"200px"},modelValue:I.value,"onUpdate:modelValue":u[0]||(u[0]=e=>I.value=e)},{default:x(()=>[(b(),f(A,null,T(D,(e,t)=>y(d,{label:e.title,key:t,value:t},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),m("div",K,[y(p,{style:{width:"200px"},modelValue:L.value,"onUpdate:modelValue":u[1]||(u[1]=e=>L.value=e)},{default:x(()=>[(b(!0),f(A,null,T(E(i)[D[I.value].BreakKey],(e,t)=>(b(),C(d,{key:t,label:t+":"+e.title,value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),u[7]||(u[7]=m("h2",null,"节点筛选：",-1)),y(v,{modelValue:de.value,"onUpdate:modelValue":u[2]||(u[2]=e=>de.value=e),onChange:ke},{default:x(()=>[(b(),f(A,null,T(D,(e,t)=>y(h,{key:t,name:t,class:"filter-checkbox",value:t},{default:x(()=>[M(j(e.title),1)]),_:2},1032,["name","value"])),64))]),_:1},8,["modelValue"])]),m("div",w,[u[8]||(u[8]=m("h2",null,"关系筛选：",-1)),y(v,{modelValue:ve.value,"onUpdate:modelValue":u[3]||(u[3]=e=>ve.value=e),onChange:ke},{default:x(()=>[(b(!0),f(A,null,T(pe.value,e=>(b(),C(h,{class:"filter-checkbox",key:e,name:e,value:e},{default:x(()=>[M(j(e),1)]),_:2},1032,["name","value"]))),128))]),_:1},8,["modelValue"])])]),_:1},8,["options"]),y(V,{ref_key:"dropdown1",ref:le,handleOpen:!0,style:_(oe)},{dropdown:x(()=>[y(g,null,{default:x(()=>[(b(),f(A,null,T(D,(e,t)=>y(k,{key:t,onClick:e=>ne(t),disabled:e.disableContextMenu.value},{default:x(()=>[M(j(e.title),1)]),_:2},1032,["onClick","disabled"])),64)),y(k,{onClick:u[4]||(u[4]=e=>ne("all")),disabled:se.value},{default:x(()=>[...u[9]||(u[9]=[M("拉取全部关系",-1)])]),_:1},8,["disabled"]),y(k,{onClick:u[5]||(u[5]=e=>{P.push({name:"relation",params:{type:ie.value,key:ce.value}})}),disabled:re.value,divided:""},{default:x(()=>[...u[10]||(u[10]=[M("作为根节点打开",-1)])]),_:1},8,["disabled"]),y(k,{divided:"",onClick:u[6]||(u[6]=e=>(()=>{let e="";switch(ie.value){case"risk":return e="riskDetail",void P.push({name:e,params:{rKey:ce.value}});case"avoidance":e="avoidances";break;case"attack-tool":e="attackTools";break;case"threat-actor":e="threatActors";break;case"ability-provider":e="abilityProviders"}P.push({name:e,hash:"#"+ce.value})})())},{default:x(()=>[...u[11]||(u[11]=[M("查看详细描述",-1)])]),_:1})]),_:1})]),default:x(()=>[u[12]||(u[12]=m("span",{class:"el-dropdown-link"},null,-1))]),_:1},8,["style"])])}}}),[["__scopeId","data-v-8edee2c2"]]);export{P as default};
