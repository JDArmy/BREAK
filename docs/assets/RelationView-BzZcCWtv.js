import{q as e,r as t,y as a,z as o,e as l,f as s,b as r}from"./element-plus-D5xJ9DPN.js";import{B as i}from"./BREAK-BmLSOlRs.js";import{a as c,u as n}from"./vue-router-BEXBg7Fd.js";import{u}from"./vue-i18n-U3rzzJhO.js";import{P as d}from"./relation-graph-CUtAT3hc.js";import{d as k,b as h,r as p,t as v,n as f,w as b,A as m,D as y,_ as x,Q as A,E,O as T,ab as R,u as B,B as g,U as C,ac as K,V as L}from"./vue-CxVCOtPj.js";import{_ as M}from"./index-o7IPHC-1.js";import"./BREAK-Risks-DMiI0UIt.js";import"./BREAK-utils-dekRhMIS.js";import"./BREAK-Avoidances-BOPqrAAw.js";import"./BREAK-AttackTools-BgWwAZyj.js";import"./BREAK-ThreatActors-Cf0Xzauk.js";const j={style:{border:"#efefef solid 1px",height:"calc(100vh - 150px)",width:"100%"}},$=["onDblclick","onContextmenu","innerHTML"],_={class:"filter-pane",id:"node-filter-pane"},O={style:{"margin-top":"8px"}},w={class:"filter-pane",id:"line-filter-pane"};var V=(e=>(e.risk="risk",e.avoidance="avoidance",e.attackTool="attack-tool",e.threatActor="threat-actor",e.all="all",e))(V||{});const N=M(k({__name:"RelationView",setup(k){const M=c(),N=n(),{t:S,locale:I}=u(),D={risk:{get title(){return S("relationType.risk")},relType:"risk",BreakKey:"risks",color:"orange",disableContextMenu:h(!1)},avoidance:{get title(){return S("relationType.avoidance")},relType:"avoidance",BreakKey:"avoidances",color:"green",disableContextMenu:h(!1)},"attack-tool":{get title(){return S("relationType.attackTool")},relType:"attack-tool",BreakKey:"attackTools",color:"blue",disableContextMenu:h(!1)},"threat-actor":{get title(){return S("relationType.threatActor")},relType:"threat-actor",BreakKey:"threatActors",color:"red",disableContextMenu:h(!1)}},U=h(M.params.type),z=h(M.params.key),H=h(),F=p({allowShowMiniToolBar:!0,disableZoom:!1,disableDragCanvas:!1,defaultExpandHolderPosition:"right",defaultShowLineLabel:!0,defaultNodeWidth:120,defaultNodeHeight:120,moveToCenterWhenRefresh:!0,zoomToFitWhenRefresh:!0});F.layout={layoutLabel:"中心布局",layoutName:"center",distance_coefficient:2,maxLayoutTimes:20,force_line_elastic:.3,force_node_repulsion:3};const J=p([]),W=p([]),q=p({rootId:z.value,nodes:J,lines:W}),P=()=>{const e=D[U.value];void 0!==i[e.BreakKey][z.value]?J.push({id:z.value,type:e.relType,text:z.value+"<br>"+S(`BREAK.${D[U.value].BreakKey}.${z.value}.title`),color:e.color}):alert(S("unknownId"))},Q=e=>{i.risks[e].avoidances.forEach(t=>{J.push({id:t,type:"avoidance",text:t+"<br>"+S(`BREAK.avoidances.${t}.title`),color:D.avoidance.color}),W.push({from:e,text:S("relationLine.avoidanceMeans"),to:t})})},X=e=>{Object.keys(i.attackTools).filter(t=>i.attackTools[t].couseRisks.includes(e)).forEach(t=>{J.push({id:t,type:"attack-tool",text:t+"<br>"+S(`BREAK.attackTools.${t}.title`),color:D["attack-tool"].color}),W.push({from:e,text:S("relationLine.makeRisk"),to:t})})},Y=e=>{Object.keys(i.threatActors).filter(t=>i.threatActors[t].couseRisks.includes(e)).forEach(t=>{J.push({id:t,type:"threat-actor",text:t+"<br>"+S(`BREAK.threatActors.${t}.title`),color:D["threat-actor"].color}),W.push({from:t,text:S("relationLine.causeRisk"),to:e})})},Z=e=>{Object.keys(i.risks).filter(t=>i.risks[t].avoidances.includes(e)).forEach(t=>{J.push({id:t,type:"risk",text:t+"<br>"+S(`BREAK.risks.${t}.title`),color:D.risk.color}),W.push({from:t,text:S("relationLine.avoidanceMeans"),to:e})})},G=e=>{i.attackTools[e].couseRisks.forEach(t=>{J.push({id:t,type:"risk",text:t+"<br>"+S(`BREAK.risks.${t}.title`),color:D.risk.color}),W.push({from:e,text:S("relationLine.makeRisk"),to:t})})},ee=e=>{i.attackTools[e].avoidances.forEach(t=>{J.push({id:t,type:"avoidance",text:t+"<br>"+S(`BREAK.avoidances.${t}.title`),color:D.avoidance.color}),W.push({from:e,text:S("relationLine.avoidanceMeans"),to:t})})},te=e=>{Object.keys(i.threatActors).filter(t=>i.threatActors[t].buildAttackTools.includes(e)).forEach(t=>{J.push({id:t,type:"threat-actor",text:t+"<br>"+S(`BREAK.threatActors.${t}.title`),color:D["threat-actor"].color}),W.push({from:t,text:S("relationLine.buildAttackTool"),to:e})});Object.keys(i.threatActors).filter(t=>i.threatActors[t].useAttackTools.includes(e)).forEach(t=>{J.push({id:t,type:"threat-actor",text:t+"<br>"+S(`BREAK.threatActors.${t}.title`),color:D["threat-actor"].color}),W.push({from:t,text:S("relationLine.useAttackTool"),to:e})})},ae=e=>{i.threatActors[e].couseRisks.forEach(t=>{J.push({id:t,type:"risk",text:t+"<br>"+S(`BREAK.risks.${t}.title`),color:D.risk.color}),W.push({from:e,text:S("relationLine.causeRisk"),to:t})})},oe=e=>{i.threatActors[e].buildAttackTools.forEach(t=>{J.push({id:t,type:"attack-tool",text:t+"<br>"+S(`BREAK.attackTools.${t}.title`),color:D["attack-tool"].color}),W.push({from:e,text:S("relationLine.buildAttackTool"),to:t})});i.threatActors[e].useAttackTools.forEach(t=>{J.push({id:t,type:"attack-tool",text:t+"<br>"+S(`BREAK.attackTools.${t}.title`),color:D["attack-tool"].color}),W.push({from:e,text:S("relationLine.useAttackTool"),to:t})})},le=()=>{(()=>{const e=new Set;W.forEach(t=>{e.add(JSON.stringify(t))}),W.splice(0,W.length),e.forEach(e=>{W.push(JSON.parse(e))})})(),H?.value?.setJsonData(q),me()},se=(e,t,a)=>{var o,l,s,r;"risk"===t?"avoidance"==e?Q(a):"attack-tool"==e?X(a):"threat-actor"==e?Y(a):"all"==e&&(Q(a),X(a),(e=>{const t=i.risks[e].avoidances;Object.keys(i.attackTools).filter(t=>i.attackTools[t].couseRisks.includes(e)).forEach(e=>{t.forEach(t=>{i.attackTools[e].avoidances.includes(t)&&W.push({from:t,text:S("relationLine.avoidanceMeans"),to:e})})})})(a),Y(a),(e=>{const t=Object.keys(i.threatActors).filter(t=>i.threatActors[t].couseRisks.includes(e)),a=Object.keys(i.attackTools).filter(t=>i.attackTools[t].couseRisks.includes(e));t.forEach(e=>{a.forEach(t=>{i.threatActors[e].useAttackTools.includes(t)?W.push({from:e,text:S("relationLine.useAttackTool"),to:t}):i.threatActors[e].buildAttackTools.includes(t)&&W.push({from:e,text:S("relationLine.buildAttackTool"),to:t})})})})(a),r=a,Object.keys(i.risks).filter(e=>e.includes(r)&&e!=r).forEach(e=>{J.push({id:e,type:"risk",text:e+"<br>"+S(`BREAK.risks.${e}.title`),color:D.risk.color,data:{isSubNode:!0}}),W.push({from:r,text:S("relationLine.subRisk"),to:e})})):"avoidance"===t?("risk"==e&&Z(a),"all"==e&&(Z(a),s=a,Object.keys(i.avoidances).filter(e=>e.includes(s)&&e!=s).forEach(e=>{J.push({id:e,type:"avoidance",text:e+"<br>"+S(`BREAK.avoidances.${e}.title`),color:D.avoidance.color,data:{isSubNode:!0}}),W.push({from:s,text:S("relationLine.subAvoidance"),to:e})}))):"attack-tool"===t?"risk"==e?G(a):"avoidance"==e?ee(a):"threat-actor"==e?te(a):"all"==e&&(G(a),ee(a),(e=>{const t=i.attackTools[e].couseRisks,a=i.attackTools[e].avoidances;t.forEach(e=>{i.risks[e].avoidances.forEach(t=>{a.includes(t)&&W.push({from:e,text:S("relationLine.avoidanceMeans"),to:t})})})})(a),te(a),(e=>{const t=Object.keys(i.threatActors).filter(t=>i.threatActors[t].buildAttackTools.includes(e)),a=Object.keys(i.threatActors).filter(t=>i.threatActors[t].useAttackTools.includes(e)),o=i.attackTools[e].couseRisks;t.forEach(e=>{o.forEach(t=>{i.threatActors[e].couseRisks.includes(t)&&W.push({from:t,text:S("relationLine.attackToolMaker"),to:e})})}),a.forEach(e=>{o.forEach(t=>{i.threatActors[e].couseRisks.includes(t)&&W.push({from:e,text:S("relationLine.causeRisk"),to:t})})})})(a),l=a,Object.keys(i.attackTools).filter(e=>e.includes(l)&&e!=l).forEach(e=>{J.push({id:e,type:"attack-tool",text:e+"<br>"+S(`BREAK.attackTools.${e}.title`),color:D["attack-tool"].color,data:{isSubNode:!0}}),W.push({from:l,text:S("relationLine.subAttackTool"),to:e})})):"threat-actor"===t&&("risk"==e?ae(a):"attack-tool"==e?oe(a):"all"==e&&(ae(a),oe(a),(e=>{const t=[...i.threatActors[e].buildAttackTools,...i.threatActors[e].useAttackTools],a=i.threatActors[e].couseRisks;t.forEach(e=>{a.forEach(t=>{i.attackTools[e].couseRisks.includes(t)&&W.push({from:e,text:S("relationLine.causeRisk"),to:t})})})})(a),o=a,Object.keys(i.threatActors).filter(e=>e.includes(o)&&e!=o).forEach(e=>{J.push({id:e,type:"threat-actor",text:e+"<br>"+S(`BREAK.threatActors.${e}.title`),color:D["threat-actor"].color,data:{isSubNode:!0}}),W.push({from:o,text:S("relationLine.subThreatActor"),to:e})}))),le()};v(()=>{if(!Object.values(V).includes(M.params.type)||!Object.keys(i[D[M.params.type].BreakKey]).includes(M.params.key))return alert(S("unknownTypeOrId")),void N.push({name:"relation",params:{type:"risk",key:"R0001"}}).then(()=>{location.reload()});P(),se("all",U.value,z.value),f(()=>re())}),b(()=>z.value,e=>{e!==M.params.key&&N.push({name:"relation",params:{type:U.value,key:e}})}),b(()=>[M.params.type,M.params.key],()=>{U.value=M.params.type,z.value=M.params.key,J.splice(0,J.length),W.splice(0,W.length),P(),se("all",U.value,z.value)}),b(I,()=>{J.splice(0,J.length),W.splice(0,W.length),ye.value=[],P(),se("all",U.value,z.value),re()});const re=()=>{const e={"全屏/退出全屏":S("toolbar.fullscreen"),"放大":S("toolbar.zoomIn"),"缩小":S("toolbar.zoomOut"),"点击停止自动布局":S("toolbar.stopAutoLayout"),"点击开始自动调整布局":S("toolbar.autoLayout"),"刷新":S("toolbar.refresh"),"下载图片":S("toolbar.download")};document.querySelectorAll(".rel-toolbar .c-mb-button, .c-mini-toolbar .c-mb-button").forEach(t=>{const a=t.getAttribute("title");a&&e[a]&&t.setAttribute("title",e[a])})},ie=p({position:"absolute",zIndex:65535,top:"0px",left:"0px",display:"none"}),ce=h(),ne=h(!1),ue=h(!1),de=h(""),ke=h(""),he=(e,t)=>{switch(ie.top=t.clientY+"px",ie.left=t.clientX+"px",ie.display="block",ce.value?.handleOpen(),e.type){case"risk":D.risk.disableContextMenu.value=!0,D.avoidance.disableContextMenu.value=!1,D["attack-tool"].disableContextMenu.value=!1,D["threat-actor"].disableContextMenu.value=!1,ne.value=!1,ue.value=!1;break;case"avoidance":D.risk.disableContextMenu.value=!1,D.avoidance.disableContextMenu.value=!0,D["attack-tool"].disableContextMenu.value=!0,D["threat-actor"].disableContextMenu.value=!0,ne.value=!1,ue.value=!1;break;case"attack-tool":D.risk.disableContextMenu.value=!1,D.avoidance.disableContextMenu.value=!1,D["attack-tool"].disableContextMenu.value=!0,D["threat-actor"].disableContextMenu.value=!1,ne.value=!1,ue.value=!1;break;case"threat-actor":D.risk.disableContextMenu.value=!1,D.avoidance.disableContextMenu.value=!0,D["attack-tool"].disableContextMenu.value=!1,D["threat-actor"].disableContextMenu.value=!0,ne.value=!1,ue.value=!1}e.id==z.value&&(ue.value=!0),de.value=e.type,ke.value=e.id},pe=e=>{se(e,de.value,ke.value)},ve=h(["risk","avoidance","attack-tool","threat-actor"]),fe=h(!0),be=h([]),me=()=>{be.value.splice(0,be.value.length),W.forEach(e=>{be.value.includes(e.text)||be.value.push(e.text)}),be.value.forEach(e=>{ye.value.includes(e)||ye.value.push(e)})},ye=h(be.value),xe=()=>{const e=H.value?.getInstance().getNodes(),t=H.value?.getInstance().getLinks();e?.forEach(e=>{const t=e.data?.isSubNode,a=!ve.value.includes(e.type)||t&&!fe.value;e.isHide=a}),t?.forEach(e=>{e.relations.forEach(e=>{e.isHide=!ye.value.includes(e.text)})}),H.value?.getInstance().dataUpdated(),H.value?.getInstance().refresh(!0)};return(c,n)=>{const u=t,k=e,h=o,p=a,v=s,f=l,b=r;return m(),y("div",j,[x(B(d),{ref_key:"graphRef$",ref:H,options:F},{node:A(({node:e})=>[E("div",{style:{cursor:"pointer","font-size":"16px",display:"flex",height:"inherit","align-items":"center","justify-content":"center"},onDblclick:t=>he(e,t),onContextmenu:t=>he(e,t),innerHTML:e.text},null,40,$)]),"graph-plug":A(()=>[E("div",_,[E("div",null,[x(k,{style:{width:"200px"},modelValue:U.value,"onUpdate:modelValue":n[0]||(n[0]=e=>U.value=e)},{default:A(()=>[(m(),y(T,null,R(D,(e,t)=>x(u,{label:e.title,key:t,value:t},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),E("div",O,[x(k,{style:{width:"200px"},modelValue:z.value,"onUpdate:modelValue":n[1]||(n[1]=e=>z.value=e)},{default:A(()=>[(m(!0),y(T,null,R(B(i)[D[U.value].BreakKey],(e,t)=>(m(),g(u,{key:t,label:t+":"+c.$t(`BREAK.${D[U.value].BreakKey}.${t}.title`),value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),E("h2",null,C(c.$t("nodeFilter")),1),x(p,{modelValue:ve.value,"onUpdate:modelValue":n[2]||(n[2]=e=>ve.value=e),onChange:xe},{default:A(()=>[(m(),y(T,null,R(D,(e,t)=>x(h,{key:t,name:t,class:"filter-checkbox",value:t},{default:A(()=>[K(C(e.title),1)]),_:2},1032,["name","value"])),64))]),_:1},8,["modelValue"]),x(h,{modelValue:fe.value,"onUpdate:modelValue":n[3]||(n[3]=e=>fe.value=e),class:"filter-checkbox",onChange:xe},{default:A(()=>[K(C(c.$t("subNodeFilter")),1)]),_:1},8,["modelValue"])]),E("div",w,[E("h2",null,C(c.$t("lineFilter")),1),x(p,{modelValue:ye.value,"onUpdate:modelValue":n[4]||(n[4]=e=>ye.value=e),onChange:xe},{default:A(()=>[(m(!0),y(T,null,R(be.value,e=>(m(),g(h,{class:"filter-checkbox",key:e,name:e,value:e},{default:A(()=>[K(C(e),1)]),_:2},1032,["name","value"]))),128))]),_:1},8,["modelValue"])])]),_:1},8,["options"]),x(b,{ref_key:"dropdown1",ref:ce,handleOpen:!0,style:L(ie)},{dropdown:A(()=>[x(f,null,{default:A(()=>[(m(),y(T,null,R(D,(e,t)=>x(v,{key:t,onClick:e=>pe(t),disabled:e.disableContextMenu.value},{default:A(()=>[K(C(e.title),1)]),_:2},1032,["onClick","disabled"])),64)),x(v,{onClick:n[5]||(n[5]=e=>pe("all")),disabled:ne.value},{default:A(()=>[K(C(c.$t("fetchAllRelations")),1)]),_:1},8,["disabled"]),x(v,{onClick:n[6]||(n[6]=e=>{N.push({name:"relation",params:{type:de.value,key:ke.value}})}),disabled:ue.value,divided:""},{default:A(()=>[K(C(c.$t("openAsRoot")),1)]),_:1},8,["disabled"]),x(v,{divided:"",onClick:n[7]||(n[7]=e=>(()=>{let e="";switch(de.value){case"risk":return e="riskDetail",void N.push({name:e,params:{rKey:ke.value}});case"avoidance":e="avoidances";break;case"attack-tool":e="attackTools";break;case"threat-actor":e="threatActors"}N.push({name:e,hash:"#"+ke.value})})())},{default:A(()=>[K(C(c.$t("viewDetail")),1)]),_:1})]),_:1})]),default:A(()=>[n[8]||(n[8]=E("span",{class:"el-dropdown-link"},null,-1))]),_:1},8,["style"])])}}}),[["__scopeId","data-v-aaba57dc"]]);export{N as default};
