import{q as e,r as t,y as a,z as o,e as l,f as s,b as r}from"./element-plus-D5xJ9DPN.js";import{B as i}from"./BREAK-BP-I2eRa.js";import{a as c,u}from"./vue-router-BEXBg7Fd.js";import{P as n}from"./relation-graph-CUtAT3hc.js";import{d,b as p,r as v,t as h,w as k,A as b,D as f,_ as y,Q as x,E as m,O as A,ab as E,u as T,B as C,ac as M,U as j,V as _}from"./vue-CxVCOtPj.js";import{_ as O}from"./index-C-Ob5KKK.js";import"./BREAK-Risks-tud6J5-y.js";import"./BREAK-utils-dekRhMIS.js";import"./BREAK-Avoidances-CkuVuIR8.js";import"./BREAK-AttackTools-B7v_fDTB.js";import"./BREAK-ThreatActors-DscyYbs6.js";import"./vue-i18n-B9uFukkq.js";const g={style:{border:"#efefef solid 1px",height:"calc(100vh - 150px)",width:"100%"}},R=["onDblclick","onContextmenu","innerHTML"],B={class:"filter-pane",id:"node-filter-pane"},K={class:"filter-pane",id:"line-filter-pane"};var w=(e=>(e.risk="risk",e.avoidance="avoidance",e.attackTool="attack-tool",e.threatActor="threat-actor",e.abilityProvider="ability-provider",e.all="all",e))(w||{});const V=O(d({__name:"RelationView",setup(d){const O=c(),V=u(),P={risk:{title:"风险",relType:"risk",BreakKey:"risks",color:"orange",disableContextMenu:p(!1)},avoidance:{title:"规避手段",relType:"avoidance",BreakKey:"avoidances",color:"green",disableContextMenu:p(!1)},"attack-tool":{title:"攻击工具",relType:"attack-tool",BreakKey:"attackTools",color:"blue",disableContextMenu:p(!1)},"threat-actor":{title:"威胁行为者",relType:"threat-actor",BreakKey:"threatActors",color:"red",disableContextMenu:p(!1)},"ability-provider":{title:"能力提供者",relType:"ability-provider",BreakKey:"abilityProviders",color:"purple",disableContextMenu:p(!1)}},D=p(O.params.type),I=p(O.params.key),L=p(),U=v({allowShowMiniToolBar:!0,disableZoom:!1,disableDragCanvas:!1,defaultExpandHolderPosition:"right",defaultShowLineLabel:!0});U.layout={layoutLabel:"中心布局",layoutName:"center",distance_coefficient:2,maxLayoutTimes:20,force_line_elastic:.3,force_node_repulsion:3};const H=v([]),S=v([]),N=v({rootId:I.value,nodes:H,lines:S}),z=()=>{const e=P[D.value],t=i[e.BreakKey][I.value];void 0!==t?H.push({id:I.value,type:e.relType,text:I.value+"<br>"+t.title,color:e.color}):alert("未知ID")},J=e=>{i.risks[e].avoidances.forEach(t=>{const a=i.avoidances[t];H.push({id:t,type:"avoidance",text:t+"<br>"+a.title,color:P.avoidance.color}),S.push({from:e,text:"规避手段",to:t})})},q=e=>{Object.keys(i.attackTools).filter(t=>i.attackTools[t].couseRisks.includes(e)).forEach(t=>{const a=i.attackTools[t];H.push({id:t,type:"attack-tool",text:t+"<br>"+a.title,color:P["attack-tool"].color}),S.push({from:e,text:"攻击工具",to:t})})},Q=e=>{Object.keys(i.threatActors).filter(t=>i.threatActors[t].couseRisks.includes(e)).forEach(t=>{const a=i.threatActors[t];H.push({id:t,type:"threat-actor",text:t+"<br>"+a.title,color:P["threat-actor"].color}),S.push({from:t,text:"造成风险",to:e})})},X=e=>{Object.keys(i.risks).filter(t=>i.risks[t].avoidances.includes(e)).forEach(t=>{const a=i.risks[t];H.push({id:t,type:"risk",text:t+"<br>"+a.title,color:P.risk.color}),S.push({from:t,text:"规避手段",to:e})})},Y=e=>{Object.keys(i.abilityProviders).filter(t=>Object.keys(i.abilityProviders[t].abilities).includes(e)).forEach(t=>{const a=i.abilityProviders[t];H.push({id:t,type:"ability-provider",text:t+"<br>"+a.title,color:P["ability-provider"].color}),S.push({from:e,text:"能力提供者",to:t})})},Z=e=>{i.attackTools[e].couseRisks.forEach(t=>{const a=i.risks[t];H.push({id:t,type:"risk",text:t+"<br>"+a.title,color:P.risk.color}),S.push({from:e,text:"制造风险",to:t})})},$=e=>{i.attackTools[e].avoidances.forEach(t=>{const a=i.avoidances[t];H.push({id:t,type:"avoidance",text:t+"<br>"+a.title,color:P.avoidance.color}),S.push({from:e,text:"规避手段",to:t})})},F=e=>{Object.keys(i.threatActors).filter(t=>i.threatActors[t].buildAttackTools.includes(e)).forEach(t=>{const a=i.threatActors[t];H.push({id:t,type:"threat-actor",text:t+"<br>"+a.title,color:P["threat-actor"].color}),S.push({from:t,text:"制作攻击工具",to:e})});Object.keys(i.threatActors).filter(t=>i.threatActors[t].useAttackTools.includes(e)).forEach(t=>{const a=i.threatActors[t];H.push({id:t,type:"threat-actor",text:t+"<br>"+a.title,color:P["threat-actor"].color}),S.push({from:t,text:"使用攻击工具",to:e})})},G=e=>{i.threatActors[e].couseRisks.forEach(t=>{const a=i.risks[t];H.push({id:t,type:"risk",text:t+"<br>"+a.title,color:P.risk.color}),S.push({from:e,text:"造成风险",to:t})})},W=e=>{i.threatActors[e].buildAttackTools.forEach(t=>{const a=i.attackTools[t];H.push({id:t,type:"attack-tool",text:t+"<br>"+a.title,color:P["attack-tool"].color}),S.push({from:e,text:"制作攻击工具",to:t})});i.threatActors[e].useAttackTools.forEach(t=>{const a=i.attackTools[t];H.push({id:t,type:"attack-tool",text:t+"<br>"+a.title,color:P["attack-tool"].color}),S.push({from:e,text:"使用攻击工具",to:t})})},ee=()=>{(()=>{const e=new Set;S.forEach(t=>{e.add(JSON.stringify(t))}),S.splice(0,S.length),e.forEach(e=>{S.push(JSON.parse(e))})})(),L?.value?.setJsonData(N),pe()},te=(e,t,a)=>{var o,l,s,r,c;"risk"===t?"avoidance"==e?J(a):"attack-tool"==e?q(a):"threat-actor"==e?Q(a):"all"==e&&(J(a),q(a),(e=>{const t=i.risks[e].avoidances;Object.keys(i.attackTools).filter(t=>i.attackTools[t].couseRisks.includes(e)).forEach(e=>{t.forEach(t=>{i.attackTools[e].avoidances.includes(t)&&S.push({from:t,text:"规避手段",to:e})})})})(a),Q(a),(e=>{const t=Object.keys(i.threatActors).filter(t=>i.threatActors[t].couseRisks.includes(e)),a=Object.keys(i.attackTools).filter(t=>i.attackTools[t].couseRisks.includes(e));t.forEach(e=>{a.forEach(t=>{i.threatActors[e].useAttackTools.includes(t)?S.push({from:e,text:"使用攻击工具",to:t}):i.threatActors[e].buildAttackTools.includes(t)&&S.push({from:e,text:"制作攻击工具",to:t})})})})(a),c=a,Object.keys(i.risks).filter(e=>e.includes(c)&&e!=c).forEach(e=>{H.push({id:e,type:"risk",text:e+"<br>"+i.risks[e].title,color:P.risk.color}),S.push({from:c,text:"子风险",to:e})})):"avoidance"===t?("risk"==e&&X(a),"ability-provider"==e&&Y(a),"all"==e&&(X(a),Y(a),r=a,Object.keys(i.avoidances).filter(e=>e.includes(r)&&e!=r).forEach(e=>{H.push({id:e,type:"avoidance",text:e+"<br>"+i.avoidances[e].title,color:P.avoidance.color}),S.push({from:r,text:"子规避手段",to:e})}))):"attack-tool"===t?"risk"==e?Z(a):"avoidance"==e?$(a):"threat-actor"==e?F(a):"all"==e&&(Z(a),$(a),(e=>{const t=i.attackTools[e].couseRisks,a=i.attackTools[e].avoidances;t.forEach(e=>{i.risks[e].avoidances.forEach(t=>{a.includes(t)&&S.push({from:e,text:"规避手段",to:t})})})})(a),F(a),(e=>{const t=Object.keys(i.threatActors).filter(t=>i.threatActors[t].buildAttackTools.includes(e)),a=Object.keys(i.threatActors).filter(t=>i.threatActors[t].useAttackTools.includes(e)),o=i.attackTools[e].couseRisks;t.forEach(e=>{o.forEach(t=>{i.threatActors[e].couseRisks.includes(t)&&S.push({from:t,text:"攻击工具制造者",to:e})})}),a.forEach(e=>{o.forEach(t=>{i.threatActors[e].couseRisks.includes(t)&&S.push({from:e,text:"造成风险",to:t})})})})(a),s=a,Object.keys(i.attackTools).filter(e=>e.includes(s)&&e!=s).forEach(e=>{H.push({id:e,type:"attack-tool",text:e+"<br>"+i.attackTools[e].title,color:P["attack-tool"].color}),S.push({from:s,text:"子攻击工具",to:e})})):"threat-actor"===t?"risk"==e?G(a):"attack-tool"==e?W(a):"all"==e&&(G(a),W(a),(e=>{const t=[...i.threatActors[e].buildAttackTools,...i.threatActors[e].useAttackTools],a=i.threatActors[e].couseRisks;t.forEach(e=>{a.forEach(t=>{i.attackTools[e].couseRisks.includes(t)&&S.push({from:e,text:"造成风险",to:t})})})})(a),l=a,Object.keys(i.threatActors).filter(e=>e.includes(l)&&e!=l).forEach(e=>{H.push({id:e,type:"threat-actor",text:e+"<br>"+i.threatActors[e].title,color:P["threat-actor"].color}),S.push({from:l,text:"子威胁行为者",to:e})})):"ability-provider"===t&&("avoidance"!=e&&"all"!=e||(o=a,Object.keys(i.abilityProviders[o].abilities).forEach(e=>{const t=i.avoidances[e];H.push({id:e,type:"avoidance",text:e+"<br>"+t.title,color:P.avoidance.color}),S.push({from:e,text:"能力提供者",to:o})}))),ee()};h(()=>{if(!Object.values(w).includes(O.params.type)||!Object.keys(i[P[O.params.type].BreakKey]).includes(O.params.key))return alert("未知类型或ID"),void V.push({name:"relation",params:{type:"risk",key:"R0001"}}).then(()=>{location.reload()});z(),te("all",D.value,I.value)}),k(()=>I.value,e=>{e!==O.params.key&&V.push({name:"relation",params:{type:D.value,key:e}})}),k(()=>[O.params.type,O.params.key],()=>{D.value=O.params.type,I.value=O.params.key,H.splice(0,H.length),S.splice(0,S.length),z(),te("all",D.value,I.value)});const ae=v({position:"absolute",zIndex:65535,top:"0px",left:"0px",display:"none"}),oe=p(),le=p(!1),se=p(!1),re=p(""),ie=p(""),ce=(e,t)=>{switch(ae.top=t.clientY+"px",ae.left=t.clientX+"px",ae.display="block",oe.value?.handleOpen(),e.type){case"risk":P.risk.disableContextMenu.value=!0,P.avoidance.disableContextMenu.value=!1,P["attack-tool"].disableContextMenu.value=!1,P["threat-actor"].disableContextMenu.value=!1,P["ability-provider"].disableContextMenu.value=!0,le.value=!1,se.value=!1;break;case"avoidance":P.risk.disableContextMenu.value=!1,P.avoidance.disableContextMenu.value=!0,P["attack-tool"].disableContextMenu.value=!0,P["threat-actor"].disableContextMenu.value=!0,P["ability-provider"].disableContextMenu.value=!1,le.value=!1,se.value=!1;break;case"attack-tool":P.risk.disableContextMenu.value=!1,P.avoidance.disableContextMenu.value=!1,P["attack-tool"].disableContextMenu.value=!0,P["threat-actor"].disableContextMenu.value=!1,P["ability-provider"].disableContextMenu.value=!0,le.value=!1,se.value=!1;break;case"threat-actor":P.risk.disableContextMenu.value=!1,P.avoidance.disableContextMenu.value=!0,P["attack-tool"].disableContextMenu.value=!1,P["threat-actor"].disableContextMenu.value=!0,P["ability-provider"].disableContextMenu.value=!0,le.value=!1,se.value=!1;break;case"ability-provider":P.risk.disableContextMenu.value=!0,P.avoidance.disableContextMenu.value=!1,P["attack-tool"].disableContextMenu.value=!0,P["threat-actor"].disableContextMenu.value=!0,P["ability-provider"].disableContextMenu.value=!0,le.value=!0,se.value=!1}e.id==I.value&&(se.value=!0),re.value=e.type,ie.value=e.id},ue=e=>{te(e,re.value,ie.value)},ne=p(["risk","avoidance","attack-tool","threat-actor","ability-provider"]),de=p([]),pe=()=>{de.value.splice(0,de.value.length),S.forEach(e=>{de.value.includes(e.text)||de.value.push(e.text)})},ve=p(de.value),he=()=>{const e=L.value?.getInstance().getNodes(),t=L.value?.getInstance().getLinks();e?.forEach(e=>{let t=!1;ne.value.includes(e.type)||(t=!0),e.opacity=t?.1:1}),t?.forEach(e=>{e.relations.forEach(e=>{ve.value.includes(e.text)?e.isHide=!1:e.isHide=!0})}),L.value?.getInstance().dataUpdated()};return(c,u)=>{const d=t,p=e,v=o,h=a,k=s,O=l,w=r;return b(),f("div",g,[y(T(n),{ref_key:"graphRef$",ref:L,options:U},{node:x(({node:e})=>[m("div",{style:{cursor:"pointer","font-size":"xx-small",display:"flex",height:"inherit","align-items":"center","justify-content":"center"},onDblclick:t=>ce(e,t),onContextmenu:t=>ce(e,t),innerHTML:e.text},null,40,R)]),"graph-plug":x(()=>[m("div",B,[m("div",null,[y(p,{style:{width:"200px"},modelValue:D.value,"onUpdate:modelValue":u[0]||(u[0]=e=>D.value=e)},{default:x(()=>[(b(),f(A,null,E(P,(e,t)=>y(d,{label:e.title,key:t,value:t},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),m("div",null,[y(p,{style:{width:"200px"},modelValue:I.value,"onUpdate:modelValue":u[1]||(u[1]=e=>I.value=e)},{default:x(()=>[(b(!0),f(A,null,E(T(i)[P[D.value].BreakKey],(e,t)=>(b(),C(d,{key:t,label:t+":"+e.title,value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),u[7]||(u[7]=m("h2",null,"节点筛选：",-1)),y(h,{modelValue:ne.value,"onUpdate:modelValue":u[2]||(u[2]=e=>ne.value=e),onChange:he},{default:x(()=>[(b(),f(A,null,E(P,(e,t)=>y(v,{key:t,name:t,class:"filter-checkbox",label:t,value:t},{default:x(()=>[M(j(e.title),1)]),_:2},1032,["name","label","value"])),64))]),_:1},8,["modelValue"])]),m("div",K,[u[8]||(u[8]=m("h2",null,"关系筛选：",-1)),y(h,{modelValue:ve.value,"onUpdate:modelValue":u[3]||(u[3]=e=>ve.value=e),onChange:he},{default:x(()=>[(b(!0),f(A,null,E(de.value,e=>(b(),C(v,{class:"filter-checkbox",key:e,label:e,name:e},{default:x(()=>[M(j(e),1)]),_:2},1032,["label","name"]))),128))]),_:1},8,["modelValue"])])]),_:1},8,["options"]),y(w,{ref_key:"dropdown1",ref:oe,handleOpen:!0,style:_(ae)},{dropdown:x(()=>[y(O,null,{default:x(()=>[(b(),f(A,null,E(P,(e,t)=>y(k,{key:t,onClick:e=>ue(t),disabled:e.disableContextMenu.value},{default:x(()=>[M(j(e.title),1)]),_:2},1032,["onClick","disabled"])),64)),y(k,{onClick:u[4]||(u[4]=e=>ue("all")),disabled:le.value},{default:x(()=>[...u[9]||(u[9]=[M("拉取全部关系",-1)])]),_:1},8,["disabled"]),y(k,{onClick:u[5]||(u[5]=e=>{V.push({name:"relation",params:{type:re.value,key:ie.value}})}),disabled:se.value,divided:""},{default:x(()=>[...u[10]||(u[10]=[M("作为根节点打开",-1)])]),_:1},8,["disabled"]),y(k,{divided:"",onClick:u[6]||(u[6]=e=>(()=>{let e="";switch(re.value){case"risk":return e="riskDetail",void V.push({name:e,params:{rKey:ie.value}});case"avoidance":e="avoidances";break;case"attack-tool":e="attackTools";break;case"threat-actor":e="threatActors";break;case"ability-provider":e="abilityProviders"}V.push({name:e,hash:"#"+ie.value})})())},{default:x(()=>[...u[11]||(u[11]=[M("查看详细描述",-1)])]),_:1})]),_:1})]),default:x(()=>[u[12]||(u[12]=m("span",{class:"el-dropdown-link"},null,-1))]),_:1},8,["style"])])}}}),[["__scopeId","data-v-4a57b8cb"]]);export{V as default};
